/*RELATORIO GERAL DA ORDEM DE SERVIÇO*/
CREATE VIEW VW_RELATORIO AS
SELECT CONCAT(C.PNOME,' ',C.SNOME) AS 'CLIENTE',C.TELEFONE 'CONTATO', GROUP_CONCAT(M.NOME,' ') AS 'EQUIPE RESPONSÁVEL',
CONCAT(VE.MODELO,' ',VE.COR,' DA ',VE.MARCA) AS 'VEÍCULO',VE.PLACA,
S.TIPODESERVIÇO,IFNULL(GROUP_CONCAT(P.NOME,' '),0) AS 'PEÇAS USADAS' ,
ROUND(SUM(IFNULL(V.QUANTIDADE*P.VALORUNITARIO,0)),2)+O.VALOREQUIPE AS 'VALOR DO SERVIÇO',
O.DATADEEMISSÃO AS 'DATA DE ENTRADA',O.DATADEENTREGA AS 'DATA DE ENTREGA', 
O.DATADEENTREGA-O.DATADEEMISSÃO AS 'DIAS PARA ENTREGA' FROM VALOR V
INNER JOIN PEÇAS P ON V.IDPEÇAS=P.IDPEÇAS
RIGHT JOIN OS O ON V.IDOS=O.IDOS
INNER JOIN SERVIÇO S ON O.IDOS=S.IDOS
INNER JOIN VEÍCULO VE ON S.IDVEICULO=VE.IDVEICULO
INNER JOIN CLIENTE C ON VE.IDCLIENTE=C.IDCLIENTE
INNER JOIN EQUIPE E ON O.IDOS=E.IDOS
INNER JOIN MECANICO M ON E.IDMECANICO=M.IDMECANICO
GROUP BY S.IDOS
ORDER BY O.DATADEENTREGA;


CREATE TABLE OSBACKUP(
	VALOREQUIPE DECIMAL(10,2),
	DATADEEMISSÃO DATE,
	DATADEENTREGA DATE,
);

DELIMITER $

CREATE TRIGGER BACKUP_OS
BEFORE DELETE ON OS
FOR EACH ROW
BEGIN
	
	INSERT INTO OSBACKUP VALUES(OLD.VALOREQUIPE,
	OLD.DATADEEMISSÃO,OLD.DATADEENTREGA);

END
$

DELIMITER ;

DELIMITER $

CREATE TRIGGER BACKUP_OS
BEFORE UPDATE ON OS
FOR EACH ROW
BEGIN
	
	INSERT INTO OSBACKUP VALUES(OLD.VALOREQUIPE,
	OLD.DATADEEMISSÃO,OLD.DATADEENTREGA);

END
$

DELIMITER ;

DELIMITER $

CREATE TRIGGER OSCANCELADA
BEFORE INSERT ON OS
FOR EACH ROW
BEGIN
	
	IF (DATADEENTREGA-DATADEEMISSÃO)<2 THEN VALOREQUIPE=200.00
	ELSE VALOREQUIPE=100.00

END
$
